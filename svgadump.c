/******************************************************************************
 * Copyright (c) 2024 Jaroslav Hensl                                          *
 *                                                                            *
 * Permission is hereby granted, free of charge, to any person                *
 * obtaining a copy of this software and associated documentation             *
 * files (the "Software"), to deal in the Software without                    *
 * restriction, including without limitation the rights to use,               *
 * copy, modify, merge, publish, distribute, sublicense, and/or sell          *
 * copies of the Software, and to permit persons to whom the                  *
 * Software is furnished to do so, subject to the following                   *
 * conditions:                                                                *
 *                                                                            *
 * The above copyright notice and this permission notice shall be             *
 * included in all copies or substantial portions of the Software.            *
 *                                                                            *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,            *
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES            *
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND                   *
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT                *
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,               *
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING               *
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR              *
 * OTHER DEALINGS IN THE SOFTWARE.                                            *
 *                                                                            *
*******************************************************************************/
#include <windows.h>
#include <wingdi.h>
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <ctype.h>

#define SVGA
#include "win9x/3d_accel.h"

#include "gallium/drivers/svga/include/svga_reg.h"
#include "gallium/drivers/svga/include/svga3d_types.h"
#include "gallium/drivers/svga/include/svga3d_devcaps.h"

typedef struct enumitem
{
	DWORD v;
	const char *n;
} enumitem_t;

/* tables are at the end of this file */
extern const enumitem_t fbhda_flags[];
extern const enumitem_t regnames[];
extern const enumitem_t fifoname[];
extern const enumitem_t devcaps[];
extern const enumitem_t cap_flags[];
extern const enumitem_t cap2_flags[];
extern const enumitem_t fifocap_flags[];

#define MAX_REGS 256
#define MAX_FIFO 1024
#define MAX_CAPS 512

/*** standard function, see more on win9x/3d_accel.c ***/

FBHDA_t *hda = NULL;
HANDLE hda_vxd = INVALID_HANDLE_VALUE;

void FBHDA_load()
{
	HWND hDesktop = GetDesktopWindow();
	HDC hdc = GetDC(hDesktop);
	char strbuf[PATH_MAX];

	if(ExtEscape(hdc, OP_FBHDA_SETUP, 0, NULL, sizeof(FBHDA_t *), (LPVOID)&hda))
	{
		if(hda != NULL)
		{
			if(hda->cb == sizeof(FBHDA_t) && hda->version == API_3DACCEL_VER)
			{
				strcpy(strbuf, "\\\\.\\");
				strcat(strbuf, hda->vxdname);
				
				hda_vxd = CreateFileA(strbuf, 0, 0, 0, CREATE_NEW, FILE_FLAG_DELETE_ON_CLOSE, 0);
				
				return;
			}
			else
			{
				printf("error FBHDA_load(): wrong version, sizeof(FBHDA_t) = %ld vs %d, API_3DACCEL_VER = %ld vs %d\n",
					hda->cb, sizeof(FBHDA_t), hda->version, API_3DACCEL_VER
				);
			}
		}
		else
		{
			printf("error FBHDA_load(): NULL from ExtEscape(..., OP_FBHDA_SETUP, ...)");
		}
	}
	else
	{
			printf("error FBHDA_load(): ExtEscape failed\n");
	}
	
	hda = NULL;
}

void FBHDA_free()
{
	if(hda_vxd != INVALID_HANDLE_VALUE)
	{
		CloseHandle(hda_vxd);
	}
}

FBHDA_t *FBHDA_setup()
{
	return hda;
}

void SVGA_query_vector(DWORD type, DWORD index_start, DWORD count, DWORD *out)
{
	DWORD ioin[3] = {
		type,
		index_start,
		count
	};
	
	DeviceIoControl(hda_vxd, OP_SVGA_QUERY_VECTOR,
		(LPVOID)ioin, sizeof(DWORD)*3, (LPVOID)out, sizeof(DWORD)*count,
		NULL, NULL);
}

BOOL validate(FBHDA_t *info)
{
	if(info == NULL)
	{
		printf("FBHDA is not supported!\n");
		return FALSE;
	}
	
	return TRUE;
}

DWORD dump_regs[MAX_REGS];
DWORD dump_fifo[MAX_FIFO];
DWORD dump_caps[MAX_CAPS];

void readmem()
{
	SVGA_query_vector(SVGA_QUERY_REGS, 0, MAX_REGS, &dump_regs[0]);
	SVGA_query_vector(SVGA_QUERY_FIFO, 0, MAX_FIFO, &dump_fifo[0]);
	SVGA_query_vector(SVGA_QUERY_CAPS, 0, MAX_CAPS, &dump_caps[0]);
}

void dump_flags(FILE *f, const enumitem_t *names, DWORD val)
{
	const enumitem_t *flag;
	
	for(flag = names; flag->n != NULL; flag++)
	{
		if((val & flag->v) != 0)
		{
			fprintf(f, "\t%s\r\n", flag->n);
		}
	}
}

void dump(FILE *f)
{
	const enumitem_t *item;
	fprintf(f, "================   SVGA registry  ================\r\n");
	for(item = &regnames[0]; item->n != NULL; item++)
		fprintf(f, "[%04ld] %s = 0x%08lX (%lu)\r\n",
			item->v, item->n, dump_regs[item->v], dump_regs[item->v]);

	fprintf(f, "------ SVGA_REG_CAPABILITIES = 0x%08lX --------\r\n", dump_regs[SVGA_REG_CAPABILITIES]);
	dump_flags(f, cap_flags, dump_regs[SVGA_REG_CAPABILITIES]);
	
	fprintf(f, "-------------- SVGA_REG_CAP2 = 0x%08lX --------\r\n", dump_regs[SVGA_REG_CAP2]);
	dump_flags(f, cap2_flags, dump_regs[SVGA_REG_CAP2]);
	
	fprintf(f, "================     SVGA FIFO    ================\r\n");
	for(item = &fifoname[0]; item->n != NULL; item++)
		fprintf(f, "[%04ld] %s = 0x%08lX (%lu)\r\n",
			item->v, item->n, dump_fifo[item->v], dump_fifo[item->v]);
	
	fprintf(f, "----- SVGA_FIFO_CAPABILITIES = 0x%08lX --------\r\n", dump_fifo[SVGA_FIFO_CAPABILITIES]);
	dump_flags(f, fifocap_flags, dump_fifo[SVGA_FIFO_CAPABILITIES]);
	
	fprintf(f, "================ SVGA device caps ================\r\n");
	for(item = &devcaps[0]; item->n != NULL; item++)
		fprintf(f, "[%04ld] %s = 0x%08lX (%lu)\r\n",
			item->v, item->n, dump_caps[item->v], dump_caps[item->v]);
	
	fprintf(f, "================       EOF        ================\r\n");
}

#define LINE_MAX 250

void dump_menu()
{
	char line[LINE_MAX];
	int  line_cnt = 0;
	int  c;
	
	printf("Menu:"
		"\tp: print dump on screen\n"
		"\td: save dump to svgadump.log\n"
		"\tc: save dump to C:\\svgadump.log\n"
		"\tx: exit\n"
		"\tor enter path to dump (more than 1 char)\n");
	
	do
	{
		FILE *out = NULL;
		do
		{
			c = getchar();
			if(line_cnt < LINE_MAX-1)
			{
				if(!(line_cnt == 0 && isspace(c)))
				{
					line[line_cnt++] = c;
				}
			}
		}while(c != EOF && c != '\n');
		
		if(line_cnt > 1)
		{
			line[--line_cnt] = '\0';
		}
		
		if(line_cnt == 1)
		{
			switch(line[0])
			{
				case 'p':
					out = stdout;
					break;
				case 'd':
					out = fopen("svgadump.log", "wb");
					if(!out)
						printf("can't open svgadump.log\n");
					break;
				case 'c':
					out = fopen("C:\\svgadump.log", "wb");
					if(!out)
						printf("can't open C:\\svgadump.log\n");
					break;
				case 'x':
					printf("exiting...\n");
					c = EOF;
					break;
				default:
					printf("unknown command '%c'!\n", line[0]);
					continue;
			}
		}
		else
		{
			out = fopen(line, "wb");
			if(!out)
				printf("can't open %s\n", line);
		}
		
		if(out)
		{
			readmem();
			dump(out);
			
			if(out != stdout)
			{
				printf("dump saved!\n");
				fclose(out);
			}
		}
		
		line_cnt = 0;
	} while(c != EOF);
}

void wait_exit()
{
	int c;
	printf("press Enter to exit\n");
	do
	{
		c = getchar();
	}
	while(c != EOF && c != '\n');
}

int main(int argc, char **argv)
{
	FBHDA_load();
	
	FBHDA_t *hda = FBHDA_setup();
	
	if(hda)
	{
		printf("Display: %lux%lux%lu\n", hda->width, hda->height, hda->bpp);
		printf("Flags:\n");
		dump_flags(stdout, fbhda_flags, hda->flags);

		if(hda->flags & FB_ACCEL_VMSVGA)
		{
			printf("Conclusion: this IS VMware SVGA device, ");
			
			if(hda->flags & FB_ACCEL_VMSVGA10)
			{
				printf("vGPU10, ");
			}
			else
			{
				printf("vGPU9 or lower, ");
			}
			
			printf("3D: %s\n", ((hda->flags & FB_ACCEL_VMSVGA3D) ? "on" : "off"));
			
			dump_menu();
		}
		else
		{
			printf("Conclusion: this IS NOT VMware SVGA device!\n");
			wait_exit();
		}
	}
	else
	{
		printf("Cannot access to HW through FBHDA API\n");
		wait_exit();
	}

	FBHDA_free();
	
	return EXIT_SUCCESS;
}

/* tables */

#define ID(_e) {_e, #_e},
#define ID_TERM {0, NULL}

const enumitem_t fbhda_flags[] = {
	ID(FB_SUPPORT_FLIPING)
	ID(FB_ACCEL_VIRGE)
	ID(FB_ACCEL_CHROMIUM)
	ID(FB_ACCEL_QEMU3DFX)
	ID(FB_ACCEL_VMSVGA)
	ID(FB_ACCEL_VMSVGA3D)
	ID(FB_ACCEL_VMSVGA10)
	ID(FB_MOUSE_NO_BLIT)
	ID(FB_FORCE_SOFTWARE)
	ID(FB_ACCEL_VMSVGA10_ST)
	ID_TERM
};

const enumitem_t regnames[] = {
	ID(SVGA_REG_ID)
	ID(SVGA_REG_ENABLE)
	ID(SVGA_REG_WIDTH)
	ID(SVGA_REG_HEIGHT)
	ID(SVGA_REG_MAX_WIDTH)
	ID(SVGA_REG_MAX_HEIGHT)
	ID(SVGA_REG_DEPTH)
	ID(SVGA_REG_BITS_PER_PIXEL)
	ID(SVGA_REG_PSEUDOCOLOR)
	ID(SVGA_REG_RED_MASK)
	ID(SVGA_REG_GREEN_MASK)
	ID(SVGA_REG_BLUE_MASK)
	ID(SVGA_REG_BYTES_PER_LINE)
	ID(SVGA_REG_FB_START)
	ID(SVGA_REG_FB_OFFSET)
	ID(SVGA_REG_VRAM_SIZE)
	ID(SVGA_REG_FB_SIZE)
	ID(SVGA_REG_CAPABILITIES)
	ID(SVGA_REG_MEM_START)
	ID(SVGA_REG_MEM_SIZE)
	ID(SVGA_REG_CONFIG_DONE)
	ID(SVGA_REG_SYNC)
	ID(SVGA_REG_BUSY)
	ID(SVGA_REG_GUEST_ID)
#if MESA_MAJOR >= 25
	ID(SVGA_REG_DEAD)
#else
	ID(SVGA_REG_CURSOR_ID)
#endif
	ID(SVGA_REG_CURSOR_X)
	ID(SVGA_REG_CURSOR_Y)
	ID(SVGA_REG_CURSOR_ON)
	ID(SVGA_REG_HOST_BITS_PER_PIXEL)
	ID(SVGA_REG_SCRATCH_SIZE)
	ID(SVGA_REG_MEM_REGS)
	ID(SVGA_REG_NUM_DISPLAYS)
	ID(SVGA_REG_PITCHLOCK)
	ID(SVGA_REG_IRQMASK)
	ID(SVGA_REG_NUM_GUEST_DISPLAYS)
	ID(SVGA_REG_DISPLAY_ID)
	ID(SVGA_REG_DISPLAY_IS_PRIMARY)
	ID(SVGA_REG_DISPLAY_POSITION_X)
	ID(SVGA_REG_DISPLAY_POSITION_Y)
	ID(SVGA_REG_DISPLAY_WIDTH)
	ID(SVGA_REG_DISPLAY_HEIGHT)
	ID(SVGA_REG_GMR_ID)
	ID(SVGA_REG_GMR_DESCRIPTOR)
	ID(SVGA_REG_GMR_MAX_IDS)
	ID(SVGA_REG_GMR_MAX_DESCRIPTOR_LENGTH)
	ID(SVGA_REG_TRACES)
	ID(SVGA_REG_GMRS_MAX_PAGES)
	ID(SVGA_REG_MEMORY_SIZE)
	ID(SVGA_REG_COMMAND_LOW)
	ID(SVGA_REG_COMMAND_HIGH)
#if MESA_MAJOR >= 25
	ID(SVGA_REG_MAX_PRIMARY_MEM)
#else
	ID(SVGA_REG_MAX_PRIMARY_BOUNDING_BOX_MEM)
#endif
	ID(SVGA_REG_SUGGESTED_GBOBJECT_MEM_SIZE_KB)
	ID(SVGA_REG_DEV_CAP)
	ID(SVGA_REG_CMD_PREPEND_LOW)
#if MESA_MAJOR >= 25
	ID(SVGA_REG_CMD_PREPEND_HIGH)
#else
	ID(SVGA_REG_iCMD_PREPEND_HIGH)
#endif
	ID(SVGA_REG_SCREENTARGET_MAX_WIDTH)
	ID(SVGA_REG_SCREENTARGET_MAX_HEIGHT)
	ID(SVGA_REG_MOB_MAX_SIZE)
	ID(SVGA_REG_BLANK_SCREEN_TARGETS)
	ID(SVGA_REG_CAP2)
	ID_TERM
};

const enumitem_t fifoname[] = {
	ID(SVGA_FIFO_MIN)
	ID(SVGA_FIFO_MAX)
	ID(SVGA_FIFO_NEXT_CMD)
	ID(SVGA_FIFO_CAPABILITIES)
	ID(SVGA_FIFO_FLAGS)
	ID(SVGA_FIFO_FENCE)
	ID(SVGA_FIFO_3D_HWVERSION)
	ID(SVGA_FIFO_PITCHLOCK)
	ID(SVGA_FIFO_CURSOR_ON)
	ID(SVGA_FIFO_CURSOR_X)
	ID(SVGA_FIFO_CURSOR_Y)
	ID(SVGA_FIFO_CURSOR_COUNT)
	ID(SVGA_FIFO_CURSOR_LAST_UPDATED)
	ID(SVGA_FIFO_RESERVED)
	ID(SVGA_FIFO_CURSOR_SCREEN_ID)
	ID(SVGA_FIFO_DEAD)
	ID(SVGA_FIFO_3D_HWVERSION_REVISED)
   //SVGA_FIFO_3D_CAPS      = 32
   //SVGA_FIFO_3D_CAPS_LAST = 32 + 255
	ID(SVGA_FIFO_GUEST_3D_HWVERSION)
	ID(SVGA_FIFO_FENCE_GOAL)
	ID(SVGA_FIFO_BUSY)
	ID_TERM
};

const enumitem_t devcaps[] = {
	ID(SVGA3D_DEVCAP_3D)
	ID(SVGA3D_DEVCAP_MAX_LIGHTS)
	ID(SVGA3D_DEVCAP_MAX_TEXTURES)
	ID(SVGA3D_DEVCAP_MAX_CLIP_PLANES)
	ID(SVGA3D_DEVCAP_VERTEX_SHADER_VERSION)
	ID(SVGA3D_DEVCAP_VERTEX_SHADER)
	ID(SVGA3D_DEVCAP_FRAGMENT_SHADER_VERSION)
	ID(SVGA3D_DEVCAP_FRAGMENT_SHADER)
	ID(SVGA3D_DEVCAP_MAX_RENDER_TARGETS)
	ID(SVGA3D_DEVCAP_S23E8_TEXTURES)
	ID(SVGA3D_DEVCAP_S10E5_TEXTURES)
	ID(SVGA3D_DEVCAP_MAX_FIXED_VERTEXBLEND)
	ID(SVGA3D_DEVCAP_D16_BUFFER_FORMAT)
	ID(SVGA3D_DEVCAP_D24S8_BUFFER_FORMAT)
	ID(SVGA3D_DEVCAP_D24X8_BUFFER_FORMAT)
	ID(SVGA3D_DEVCAP_QUERY_TYPES)
	ID(SVGA3D_DEVCAP_TEXTURE_GRADIENT_SAMPLING)
	ID(SVGA3D_DEVCAP_MAX_POINT_SIZE)
	ID(SVGA3D_DEVCAP_MAX_SHADER_TEXTURES)
	ID(SVGA3D_DEVCAP_MAX_TEXTURE_WIDTH)
	ID(SVGA3D_DEVCAP_MAX_TEXTURE_HEIGHT)
	ID(SVGA3D_DEVCAP_MAX_VOLUME_EXTENT)
	ID(SVGA3D_DEVCAP_MAX_TEXTURE_REPEAT)
	ID(SVGA3D_DEVCAP_MAX_TEXTURE_ASPECT_RATIO)
	ID(SVGA3D_DEVCAP_MAX_TEXTURE_ANISOTROPY)
	ID(SVGA3D_DEVCAP_MAX_PRIMITIVE_COUNT)
	ID(SVGA3D_DEVCAP_MAX_VERTEX_INDEX)
	ID(SVGA3D_DEVCAP_MAX_VERTEX_SHADER_INSTRUCTIONS)
	ID(SVGA3D_DEVCAP_MAX_FRAGMENT_SHADER_INSTRUCTIONS)
	ID(SVGA3D_DEVCAP_MAX_VERTEX_SHADER_TEMPS)
	ID(SVGA3D_DEVCAP_MAX_FRAGMENT_SHADER_TEMPS)
	ID(SVGA3D_DEVCAP_TEXTURE_OPS)
	ID(SVGA3D_DEVCAP_SURFACEFMT_X8R8G8B8)
	ID(SVGA3D_DEVCAP_SURFACEFMT_A8R8G8B8)
	ID(SVGA3D_DEVCAP_SURFACEFMT_A2R10G10B10)
	ID(SVGA3D_DEVCAP_SURFACEFMT_X1R5G5B5)
	ID(SVGA3D_DEVCAP_SURFACEFMT_A1R5G5B5)
	ID(SVGA3D_DEVCAP_SURFACEFMT_A4R4G4B4)
	ID(SVGA3D_DEVCAP_SURFACEFMT_R5G6B5)
	ID(SVGA3D_DEVCAP_SURFACEFMT_LUMINANCE16)
	ID(SVGA3D_DEVCAP_SURFACEFMT_LUMINANCE8_ALPHA8)
	ID(SVGA3D_DEVCAP_SURFACEFMT_ALPHA8)
	ID(SVGA3D_DEVCAP_SURFACEFMT_LUMINANCE8)
	ID(SVGA3D_DEVCAP_SURFACEFMT_Z_D16)
	ID(SVGA3D_DEVCAP_SURFACEFMT_Z_D24S8)
	ID(SVGA3D_DEVCAP_SURFACEFMT_Z_D24X8)
	ID(SVGA3D_DEVCAP_SURFACEFMT_DXT1)
	ID(SVGA3D_DEVCAP_SURFACEFMT_DXT2)
	ID(SVGA3D_DEVCAP_SURFACEFMT_DXT3)
	ID(SVGA3D_DEVCAP_SURFACEFMT_DXT4)
	ID(SVGA3D_DEVCAP_SURFACEFMT_DXT5)
	ID(SVGA3D_DEVCAP_SURFACEFMT_BUMPX8L8V8U8)
	ID(SVGA3D_DEVCAP_SURFACEFMT_A2W10V10U10)
	ID(SVGA3D_DEVCAP_SURFACEFMT_BUMPU8V8)
	ID(SVGA3D_DEVCAP_SURFACEFMT_Q8W8V8U8)
	ID(SVGA3D_DEVCAP_SURFACEFMT_CxV8U8)
	ID(SVGA3D_DEVCAP_SURFACEFMT_R_S10E5)
	ID(SVGA3D_DEVCAP_SURFACEFMT_R_S23E8)
	ID(SVGA3D_DEVCAP_SURFACEFMT_RG_S10E5)
	ID(SVGA3D_DEVCAP_SURFACEFMT_RG_S23E8)
	ID(SVGA3D_DEVCAP_SURFACEFMT_ARGB_S10E5)
	ID(SVGA3D_DEVCAP_SURFACEFMT_ARGB_S23E8)
	ID(SVGA3D_DEVCAP_MISSING62)
	ID(SVGA3D_DEVCAP_MAX_VERTEX_SHADER_TEXTURES)
	ID(SVGA3D_DEVCAP_MAX_SIMULTANEOUS_RENDER_TARGETS)
	ID(SVGA3D_DEVCAP_SURFACEFMT_V16U16)
	ID(SVGA3D_DEVCAP_SURFACEFMT_G16R16)
	ID(SVGA3D_DEVCAP_SURFACEFMT_A16B16G16R16)
	ID(SVGA3D_DEVCAP_SURFACEFMT_UYVY)
	ID(SVGA3D_DEVCAP_SURFACEFMT_YUY2)
	ID(SVGA3D_DEVCAP_DEAD4)
	ID(SVGA3D_DEVCAP_DEAD5)
	ID(SVGA3D_DEVCAP_DEAD7)
	ID(SVGA3D_DEVCAP_DEAD6)
	ID(SVGA3D_DEVCAP_AUTOGENMIPMAPS)
	ID(SVGA3D_DEVCAP_SURFACEFMT_NV12)
#if MESA_MAJOR >= 25
	ID(SVGA3D_DEVCAP_DEAD10)
#else
	ID(SVGA3D_DEVCAP_SURFACEFMT_AYUV)
#endif
	ID(SVGA3D_DEVCAP_MAX_CONTEXT_IDS)
	ID(SVGA3D_DEVCAP_MAX_SURFACE_IDS)
	ID(SVGA3D_DEVCAP_SURFACEFMT_Z_DF16)
	ID(SVGA3D_DEVCAP_SURFACEFMT_Z_DF24)
	ID(SVGA3D_DEVCAP_SURFACEFMT_Z_D24S8_INT)
	ID(SVGA3D_DEVCAP_SURFACEFMT_ATI1)
	ID(SVGA3D_DEVCAP_SURFACEFMT_ATI2)
	ID(SVGA3D_DEVCAP_DEAD1)
	ID(SVGA3D_DEVCAP_DEAD8)
	ID(SVGA3D_DEVCAP_DEAD9)
	ID(SVGA3D_DEVCAP_LINE_AA)
	ID(SVGA3D_DEVCAP_LINE_STIPPLE)
	ID(SVGA3D_DEVCAP_MAX_LINE_WIDTH)
	ID(SVGA3D_DEVCAP_MAX_AA_LINE_WIDTH)
	ID(SVGA3D_DEVCAP_SURFACEFMT_YV12)
	ID(SVGA3D_DEVCAP_DEAD3)
	ID(SVGA3D_DEVCAP_TS_COLOR_KEY)
	ID(SVGA3D_DEVCAP_DEAD2)
	ID(SVGA3D_DEVCAP_DXCONTEXT)
#if MESA_MAJOR >= 25
	ID(SVGA3D_DEVCAP_DEAD11)
#else
	ID(SVGA3D_DEVCAP_MAX_TEXTURE_ARRAY_SIZE)
#endif
	ID(SVGA3D_DEVCAP_DX_MAX_VERTEXBUFFERS)
	ID(SVGA3D_DEVCAP_DX_MAX_CONSTANT_BUFFERS)
	ID(SVGA3D_DEVCAP_DX_PROVOKING_VERTEX)
	ID(SVGA3D_DEVCAP_DXFMT_X8R8G8B8)
	ID(SVGA3D_DEVCAP_DXFMT_A8R8G8B8)
	ID(SVGA3D_DEVCAP_DXFMT_R5G6B5)
	ID(SVGA3D_DEVCAP_DXFMT_X1R5G5B5)
	ID(SVGA3D_DEVCAP_DXFMT_A1R5G5B5)
	ID(SVGA3D_DEVCAP_DXFMT_A4R4G4B4)
	ID(SVGA3D_DEVCAP_DXFMT_Z_D32)
	ID(SVGA3D_DEVCAP_DXFMT_Z_D16)
	ID(SVGA3D_DEVCAP_DXFMT_Z_D24S8)
	ID(SVGA3D_DEVCAP_DXFMT_Z_D15S1)
	ID(SVGA3D_DEVCAP_DXFMT_LUMINANCE8)
	ID(SVGA3D_DEVCAP_DXFMT_LUMINANCE4_ALPHA4)
	ID(SVGA3D_DEVCAP_DXFMT_LUMINANCE16)
	ID(SVGA3D_DEVCAP_DXFMT_LUMINANCE8_ALPHA8)
	ID(SVGA3D_DEVCAP_DXFMT_DXT1)
	ID(SVGA3D_DEVCAP_DXFMT_DXT2)
	ID(SVGA3D_DEVCAP_DXFMT_DXT3)
	ID(SVGA3D_DEVCAP_DXFMT_DXT4)
	ID(SVGA3D_DEVCAP_DXFMT_DXT5)
	ID(SVGA3D_DEVCAP_DXFMT_BUMPU8V8)
	ID(SVGA3D_DEVCAP_DXFMT_BUMPL6V5U5)
	ID(SVGA3D_DEVCAP_DXFMT_BUMPX8L8V8U8)
	ID(SVGA3D_DEVCAP_DXFMT_FORMAT_DEAD1)
	ID(SVGA3D_DEVCAP_DXFMT_ARGB_S10E5)
	ID(SVGA3D_DEVCAP_DXFMT_ARGB_S23E8)
	ID(SVGA3D_DEVCAP_DXFMT_A2R10G10B10)
	ID(SVGA3D_DEVCAP_DXFMT_V8U8)
	ID(SVGA3D_DEVCAP_DXFMT_Q8W8V8U8)
	ID(SVGA3D_DEVCAP_DXFMT_CxV8U8)
	ID(SVGA3D_DEVCAP_DXFMT_X8L8V8U8)
	ID(SVGA3D_DEVCAP_DXFMT_A2W10V10U10)
	ID(SVGA3D_DEVCAP_DXFMT_ALPHA8)
	ID(SVGA3D_DEVCAP_DXFMT_R_S10E5)
	ID(SVGA3D_DEVCAP_DXFMT_R_S23E8)
	ID(SVGA3D_DEVCAP_DXFMT_RG_S10E5)
	ID(SVGA3D_DEVCAP_DXFMT_RG_S23E8)
	ID(SVGA3D_DEVCAP_DXFMT_BUFFER)
	ID(SVGA3D_DEVCAP_DXFMT_Z_D24X8)
	ID(SVGA3D_DEVCAP_DXFMT_V16U16)
	ID(SVGA3D_DEVCAP_DXFMT_G16R16)
	ID(SVGA3D_DEVCAP_DXFMT_A16B16G16R16)
	ID(SVGA3D_DEVCAP_DXFMT_UYVY)
	ID(SVGA3D_DEVCAP_DXFMT_YUY2)
	ID(SVGA3D_DEVCAP_DXFMT_NV12)
#if MESA_MAJOR >= 25
	ID(SVGA3D_DEVCAP_DXFMT_FORMAT_DEAD2)
#else
	ID(SVGA3D_DEVCAP_FORMAT_DEAD2)
#endif
	ID(SVGA3D_DEVCAP_DXFMT_R32G32B32A32_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_R32G32B32A32_UINT)
	ID(SVGA3D_DEVCAP_DXFMT_R32G32B32A32_SINT)
	ID(SVGA3D_DEVCAP_DXFMT_R32G32B32_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_R32G32B32_FLOAT)
	ID(SVGA3D_DEVCAP_DXFMT_R32G32B32_UINT)
	ID(SVGA3D_DEVCAP_DXFMT_R32G32B32_SINT)
	ID(SVGA3D_DEVCAP_DXFMT_R16G16B16A16_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_R16G16B16A16_UINT)
	ID(SVGA3D_DEVCAP_DXFMT_R16G16B16A16_SNORM)
	ID(SVGA3D_DEVCAP_DXFMT_R16G16B16A16_SINT)
	ID(SVGA3D_DEVCAP_DXFMT_R32G32_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_R32G32_UINT)
	ID(SVGA3D_DEVCAP_DXFMT_R32G32_SINT)
	ID(SVGA3D_DEVCAP_DXFMT_R32G8X24_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_D32_FLOAT_S8X24_UINT)
	ID(SVGA3D_DEVCAP_DXFMT_R32_FLOAT_X8X24)
	ID(SVGA3D_DEVCAP_DXFMT_X32_G8X24_UINT)
	ID(SVGA3D_DEVCAP_DXFMT_R10G10B10A2_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_R10G10B10A2_UINT)
	ID(SVGA3D_DEVCAP_DXFMT_R11G11B10_FLOAT)
	ID(SVGA3D_DEVCAP_DXFMT_R8G8B8A8_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_R8G8B8A8_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_R8G8B8A8_UNORM_SRGB)
	ID(SVGA3D_DEVCAP_DXFMT_R8G8B8A8_UINT)
	ID(SVGA3D_DEVCAP_DXFMT_R8G8B8A8_SINT)
	ID(SVGA3D_DEVCAP_DXFMT_R16G16_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_R16G16_UINT)
	ID(SVGA3D_DEVCAP_DXFMT_R16G16_SINT)
	ID(SVGA3D_DEVCAP_DXFMT_R32_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_D32_FLOAT)
	ID(SVGA3D_DEVCAP_DXFMT_R32_UINT)
	ID(SVGA3D_DEVCAP_DXFMT_R32_SINT)
	ID(SVGA3D_DEVCAP_DXFMT_R24G8_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_D24_UNORM_S8_UINT)
	ID(SVGA3D_DEVCAP_DXFMT_R24_UNORM_X8)
	ID(SVGA3D_DEVCAP_DXFMT_X24_G8_UINT)
	ID(SVGA3D_DEVCAP_DXFMT_R8G8_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_R8G8_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_R8G8_UINT)
	ID(SVGA3D_DEVCAP_DXFMT_R8G8_SINT)
	ID(SVGA3D_DEVCAP_DXFMT_R16_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_R16_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_R16_UINT)
	ID(SVGA3D_DEVCAP_DXFMT_R16_SNORM)
	ID(SVGA3D_DEVCAP_DXFMT_R16_SINT)
	ID(SVGA3D_DEVCAP_DXFMT_R8_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_R8_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_R8_UINT)
	ID(SVGA3D_DEVCAP_DXFMT_R8_SNORM)
	ID(SVGA3D_DEVCAP_DXFMT_R8_SINT)
	ID(SVGA3D_DEVCAP_DXFMT_P8)
	ID(SVGA3D_DEVCAP_DXFMT_R9G9B9E5_SHAREDEXP)
	ID(SVGA3D_DEVCAP_DXFMT_R8G8_B8G8_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_G8R8_G8B8_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_BC1_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_BC1_UNORM_SRGB)
	ID(SVGA3D_DEVCAP_DXFMT_BC2_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_BC2_UNORM_SRGB)
	ID(SVGA3D_DEVCAP_DXFMT_BC3_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_BC3_UNORM_SRGB)
	ID(SVGA3D_DEVCAP_DXFMT_BC4_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_ATI1)
	ID(SVGA3D_DEVCAP_DXFMT_BC4_SNORM)
	ID(SVGA3D_DEVCAP_DXFMT_BC5_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_ATI2)
	ID(SVGA3D_DEVCAP_DXFMT_BC5_SNORM)
	ID(SVGA3D_DEVCAP_DXFMT_R10G10B10_XR_BIAS_A2_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_B8G8R8A8_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_B8G8R8A8_UNORM_SRGB)
	ID(SVGA3D_DEVCAP_DXFMT_B8G8R8X8_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_B8G8R8X8_UNORM_SRGB)
	ID(SVGA3D_DEVCAP_DXFMT_Z_DF16)
	ID(SVGA3D_DEVCAP_DXFMT_Z_DF24)
	ID(SVGA3D_DEVCAP_DXFMT_Z_D24S8_INT)
	ID(SVGA3D_DEVCAP_DXFMT_YV12)
	ID(SVGA3D_DEVCAP_DXFMT_R32G32B32A32_FLOAT)
	ID(SVGA3D_DEVCAP_DXFMT_R16G16B16A16_FLOAT)
	ID(SVGA3D_DEVCAP_DXFMT_R16G16B16A16_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_R32G32_FLOAT)
	ID(SVGA3D_DEVCAP_DXFMT_R10G10B10A2_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_R8G8B8A8_SNORM)
	ID(SVGA3D_DEVCAP_DXFMT_R16G16_FLOAT)
	ID(SVGA3D_DEVCAP_DXFMT_R16G16_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_R16G16_SNORM)
	ID(SVGA3D_DEVCAP_DXFMT_R32_FLOAT)
	ID(SVGA3D_DEVCAP_DXFMT_R8G8_SNORM)
	ID(SVGA3D_DEVCAP_DXFMT_R16_FLOAT)
	ID(SVGA3D_DEVCAP_DXFMT_D16_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_A8_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_BC1_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_BC2_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_BC3_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_B5G6R5_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_B5G5R5A1_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_B8G8R8A8_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_B8G8R8X8_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_BC4_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_BC5_UNORM)
	ID(SVGA3D_DEVCAP_SM41)
	ID(SVGA3D_DEVCAP_MULTISAMPLE_2X)
	ID(SVGA3D_DEVCAP_MULTISAMPLE_4X)
	ID(SVGA3D_DEVCAP_MS_FULL_QUALITY)
	ID(SVGA3D_DEVCAP_LOGICOPS)
	ID(SVGA3D_DEVCAP_LOGIC_BLENDOPS)
	ID(SVGA3D_DEVCAP_DEAD12)
	ID(SVGA3D_DEVCAP_DXFMT_BC6H_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_BC6H_UF16)
	ID(SVGA3D_DEVCAP_DXFMT_BC6H_SF16)
	ID(SVGA3D_DEVCAP_DXFMT_BC7_TYPELESS)
	ID(SVGA3D_DEVCAP_DXFMT_BC7_UNORM)
	ID(SVGA3D_DEVCAP_DXFMT_BC7_UNORM_SRGB)
	ID(SVGA3D_DEVCAP_DEAD13)
	ID(SVGA3D_DEVCAP_SM5)
	ID(SVGA3D_DEVCAP_MULTISAMPLE_8X)
	ID(SVGA3D_DEVCAP_MAX_FORCED_SAMPLE_COUNT)
	ID(SVGA3D_DEVCAP_GL43)
	ID_TERM
};

const enumitem_t cap_flags[] = {
	ID(SVGA_CAP_RECT_COPY)
	ID(SVGA_CAP_CURSOR)
	ID(SVGA_CAP_CURSOR_BYPASS)
	ID(SVGA_CAP_CURSOR_BYPASS_2)
	ID(SVGA_CAP_8BIT_EMULATION)
	ID(SVGA_CAP_ALPHA_CURSOR)
	ID(SVGA_CAP_3D)
	ID(SVGA_CAP_EXTENDED_FIFO)
	ID(SVGA_CAP_MULTIMON)
	ID(SVGA_CAP_PITCHLOCK)
	ID(SVGA_CAP_IRQMASK)
	ID(SVGA_CAP_DISPLAY_TOPOLOGY)
	ID(SVGA_CAP_GMR)
	ID(SVGA_CAP_TRACES)
	ID(SVGA_CAP_GMR2)
	ID(SVGA_CAP_SCREEN_OBJECT_2)
	ID(SVGA_CAP_COMMAND_BUFFERS)
	ID(SVGA_CAP_DEAD1)
	ID(SVGA_CAP_CMD_BUFFERS_2)
	ID(SVGA_CAP_GBOBJECTS)
#if MESA_MAJOR >= 25
	ID(SVGA_CAP_DX)
#else
	ID(SVGA_CAP_CMD_BUFFERS_3)
#endif
	ID(SVGA_CAP_CAP2_REGISTER)
	ID_TERM
};

const enumitem_t cap2_flags[] = {
	ID(SVGA_CAP2_GROW_OTABLE)
	ID(SVGA_CAP2_INTRA_SURFACE_COPY)
	ID(SVGA_CAP2_RESERVED)
	ID_TERM
};

const enumitem_t fifocap_flags[] = {
	ID(SVGA_FIFO_CAP_FENCE)
	ID(SVGA_FIFO_CAP_ACCELFRONT)
	ID(SVGA_FIFO_CAP_PITCHLOCK)
	ID(SVGA_FIFO_CAP_VIDEO)
	ID(SVGA_FIFO_CAP_CURSOR_BYPASS_3)
	ID(SVGA_FIFO_CAP_ESCAPE)
	ID(SVGA_FIFO_CAP_RESERVE)
	ID(SVGA_FIFO_CAP_SCREEN_OBJECT)
	ID(SVGA_FIFO_CAP_GMR2)
	ID(SVGA_FIFO_CAP_3D_HWVERSION_REVISED)
	ID(SVGA_FIFO_CAP_SCREEN_OBJECT_2)
	ID(SVGA_FIFO_CAP_DEAD)
	ID_TERM
};
